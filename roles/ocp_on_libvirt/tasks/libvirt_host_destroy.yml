---
- name: "Does node exist"
  community.libvirt.virt:
    command: list_vms
  register: _ool_vms_list

- name: "Set node_not_exists"
  ansible.builtin.set_fact:
    ool_node_exists: "{{ host['name'] in _ool_vms_list.list_vms }}"

- name: "Get node status if exists"
  community.libvirt.virt:
    name: "{{ host['name'] }}"
    command: status
  register: _ool_node_status
  when: ool_node_exists

- name: "Destroy node"
  community.libvirt.virt:
    name: "{{ host['name'] }}"
    command: destroy
  when: _ool_node_status['status'] is defined and _ool_node_status['status'] == 'running'

- name: "Undefine node"
  become: true
  community.libvirt.virt:
    name: "{{ host['name'] }}"
    command: undefine
    flags: nvram
  when: ool_node_exists
...
